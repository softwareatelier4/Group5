<dom-module id="ja-distance-calc">

  <template>
    <style>
    </style>

    <iron-ajax
      auto
      id="distance-request"
      url="https://maps.googleapis.com/maps/api/distancematrix/json"
      params='{{req_distance}}'
      handle-as="json"
      on-response="_handleResponse">
    </iron-ajax>
  </template>

 <!-- AIzaSyBVciKKAq5jjZxpn_PNfNCCLbUPKxFIIkc -->

  <script>
    Polymer({
      is: "ja-distance-calc",

      properties: {
        results: {
          type: Object,
          value: {},
          observer: '_resultsChanged',
          reflectToAttribute: true,
        },
        userLocation: {
          type: String,
          value: "Lugano, Switzerland",
        },
        searchedLocation: {
          type: String,
        }
      },

      _resultsChanged: function(results) {
        this.results = results;
        if (this.searchedLocation !== "")
          this.userLocation = this.searchedLocation;
        this._computeDistances(this.results);
      },

      _getUserLocation: function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            console.log(position);
            const lat = position.coords.latitude.toString();
            const lng = position.coords.longitude.toString();
            this.userLocation = lat + ", " + lng;
          }.bind(this));
        }
      },

      _computeDistances: function(results) {
        results.forEach(function(item) {
          console.log("Current user location for request", this.userLocation);
          this.req_distance = {
            origins: this.userLocation,
            destinations: item.address,
          };
          this.$['distance-request'].generateRequest();

        }.bind(this));
      },

      _handleResponse: function(response) {
        // TODO: update fields
      },

      ready: function() {
        this._getUserLocation();
      },
    });
  </script>

</dom-module>
