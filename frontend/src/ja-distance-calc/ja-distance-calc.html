<dom-module id="ja-distance-calc">

  <template>
    <style>
    </style>

    <iron-ajax
      auto
      id="distance-request"
      url="https://maps.googleapis.com/maps/api/distancematrix/json"
      params='{{req_distance}}'
      handle-as="json"
      on-response="_handleResponse">
    </iron-ajax>
  </template>

 <!-- AIzaSyBVciKKAq5jjZxpn_PNfNCCLbUPKxFIIkc -->

  <script>
    Polymer({
      is: "ja-distance-calc",

      properties: {
        result: {
          type: Object,
          value: {},
          observer: '_resultChanged',
          reflectToAttribute: true,
        },
        userLocation: {
          type: String,
          value: "Lugano, Switzerland",
        },
        searchedLocation: {
          type: String,
          value: "Lugano, Switzerland"
        }
      },

      _resultChanged: function(result) {
        console.log("Result", result, this.userLocation);
        this.result = result;
        if (this.searchedLocation != "")
          this.userLocation = this.searchedLocation;
        this._computeDistances(this.result);
      },

      _getUserLocation: function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            console.log(position);
            const lat = position.coords.latitude.toString();
            const lng = position.coords.longitude.toString();
            this.userLocation = lat + ", " + lng;
          }.bind(this));
        }
      },

      _computeDistances: function(result) {
        console.log("Current user location for request", this.userLocation);
        this.req_distance = {
          origins: this.userLocation,
          destinations: result.address,
        };
        this.$['distance-request'].generateRequest();
      },

      _handleResponse: function(response) {
        if (response.detail.response.rows[0]) {
          const value = response.detail.response.rows[0].elements[0].distance.text;
          this.set('result.distance', value);
        }
      },

      ready: function() {
        this._getUserLocation();
      },
    });
  </script>

</dom-module>
