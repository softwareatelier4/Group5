<dom-module id="ja-distance-calc">

  <template>
    <style>
    </style>

    <iron-ajax
      auto
      id="distance-request"
      url="https://maps.googleapis.com/maps/api/distancematrix/json"
      params='{{req_distance}}'
      handle-as="json"
      on-response="_handleResponse">
    </iron-ajax>
  </template>

 <!-- AIzaSyBVciKKAq5jjZxpn_PNfNCCLbUPKxFIIkc -->

  <script>
    Polymer({
      is: "ja-distance-calc",

      properties: {
        result: {
          type: Object,
          value: {},
          observer: '_resultChanged',
          reflectToAttribute: true,
        },
        userLocation: {
          type: String,
          value: "Lugano, Switzerland",
          // reflectToAttribute: true,
          // observer: '_userLocationChanged',
        },
        searchedLocation: {
          type: String,
          value: "Lugano, Switzerland"
        }
      },

      _resultChanged: function(result) {
        console.log("Result", result, this.userLocation);
        this.result = result;
        if (this.searchedLocation != "")
          this.userLocation = this.searchedLocation;
        this._computeDistances(this.result);
      },

      _computeDistances: function(result) {
        console.log("Current user location for request", this.userLocation);
        this.req_distance = {
          origins: this.userLocation ? this.userLocation: "Lugano, Switzerland",
          destinations: result.address,
        };
        this.$['distance-request'].generateRequest();
      },

      _handleResponse: function(response) {
        const status = response.detail.response.rows[0].elements[0].status;
        if (status !== 'ZERO_RESULTS' && status !== 'NOT_FOUND') {
          const text = response.detail.response.rows[0].elements[0].distance.text;
          const value = response.detail.response.rows[0].elements[0].distance.value;
          this.set('result.distance_text', text);
          this.set('result.distance_value', value);
        }
      },

      _userLocationChanged: function(userLocation) {
        console.log("Changed user location", userLocation);
        // this.userLocation = userLocation;
      },
    });
  </script>

</dom-module>
