<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-search/paper-search.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBWdeAEXHXX_d7UsPOsPgkBJvdL5dE9rHA &libraries=places"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>


<dom-module id="ja-search-element">
  <template>
    <style>
       :host {
        display: block;
      }

      #container-dropdown {
        flex-basis: 20%;
      }

      #container-dropdown button {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 20;
        background-color: rgba(0, 0, 0, 0);
      }

      #container-dropdown paper-search-bar {
        position: absolute;
        width: 100%;
        height: 100%;
      }

      #location-search {
        flex-basis: 20%;
      }

      #field-search {
        flex-basis: 50%;
        border-top-left-radius: 3px;
        border-bottom-left-radius: 3px;
      }

      paper-button {
        /*max-width: 30px;*/
        box-shadow: none !important;
        flex-basis: 10%;
        background: #F2D847;
        border-top-left-radius: 0px;
        border-bottom-left-radius: 0px;
        margin: 0px;
      }
    </style>

    <div id="div-search" on-keydown="checkForEnter">
      <paper-search-bar label="test" id="field-search" hide-filter-button icon="search" placeholder="General"> </paper-search-bar>
      <div id="container-dropdown" class="dropdown">
        <button onclick="toggleDropdown()" class="dropbtn"></button>
        <paper-search-bar label="test" id="category-dropdown" hide-filter-button icon="work" placeholder="Category &#9660;"> </paper-search-bar>

        <div id="dropdown-elements" class="dropdown-content">
          <a class="category-links" href="#">Boh</a>
          <a class="category-links" href="#">Qualcosa</a>
          <a class="category-links" href="#">Plumber</a>
          <a class="category-links" href="#">Other</a>
        </div>
      </div>
      <paper-search-bar label="test" id="location-search" hide-filter-button icon="home" placeholder="Location"> </paper-search-bar>
      <paper-button id="button-search" raised>
        <iron-icon icon="search" suffix></iron-icon>
      </paper-button>
    </div>

    <iron-ajax id="search-request" url="http://localhost:3000/search/" params='{{req}}' handle-as="json" on-response="_handleResponse">
    </iron-ajax>
  </template>

  <script>
    Polymer({

      is: 'ja-search-element',

      listeners: {
        'button-search.tap': 'search'
      },

      properties: {
        results: {
          type: Array,
          value: [],
          reflectToAttribute: true,
          notify: true,
        },
        general: {
          type: String,
          value: "general",
          reflectToAttribute: true,
          notify: true,
        },
        category: {
          type: String,
          value: "category",
          reflectToAttribute: true,
          notify: true,
        },
        location: {
          type: String,
          value: "location",
          reflectToAttribute: true,
          notify: true,
        },
      },

      checkForEnter: function (e) {
        // check if 'enter' was pressed
        // if (e.keyCode === 13) {
        //     this.search();
        // } 
        this.search();
      },

      search: function (e) {
        console.log(this.$['field-search'].query);
        this.general = this.$['field-search'].query;
        this.category = this.$['category-dropdown'].query;
        this.location = this.$['location-search'].query;
        this.req = {
          "general": this.general,
          "category": this.category,
          "location": this.location
        };
        this.$['search-request'].generateRequest();
      },

      ready: function() {

        const inputEl = this.$['location-search'].childNodes[1].childNodes[3];
        var autocomplete = new google.maps.places.Autocomplete(inputEl);

        autocomplete.addListener('place_changed', function() {
          const address = autocomplete.getPlace().formatted_address;
          this.location = address;
          this.$['location-search'].query = address;
        }.bind(this));
      },

      _handleResponse: function(response) {
        this.results = response.detail.response;
      },

    });

    function toggleDropdown() {
      document.getElementById("dropdown-elements").classList.toggle("show");
    }

    $(document).on("click touchend", ".category-links", function () {
      document.getElementById("category-dropdown").query = $(this).text();
      console.log($(this).text());
    });

    // Close the dropdown menu if the user clicks outside of it
    window.onclick = function (event) {
      if (!event.target.matches('.dropbtn')) {

        var dropdowns = document.getElementsByClassName("dropdown-content");
        var i;
        for (i = 0; i < dropdowns.length; i++) {
          var openDropdown = dropdowns[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }
  </script>
</dom-module>