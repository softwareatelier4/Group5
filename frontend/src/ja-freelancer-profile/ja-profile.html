<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../ja-review-element/ja-review-element.html">
<dom-module id="ja-profile">

  <template>
    <style>
      /* CSS rules for your element */
      /* boh */

      #container {
        position: fixed;
        height: calc(100% - 110px);
        width: 80%!important;
        top: 100px;
        bottom: 0px;
        display: flex;
        overflow: scroll;
        flex-wrap: wrap;
        width: 100%;
        color: dimgray;
        background: white;
        border-radius: 3px;
        padding-bottom: 10px;
      }

      #container::-webkit-scrollbar {
        display: none;
      }

      #left {
        width: calc(50% - 40px);
        display: inline-block;
        padding: 20px;
        font-weight: normal;
      }

      #right {
        width: calc(50% - 40px);
        display: inline-block;
        padding: 20px;
        font-weight: normal;
      }

      #price {
        width: 100%;
        padding: 20px;
      }

      #description {
        width: 100%;
        padding: 20px;
      }

      #imagediv {
        float: top left;
        width: 150px;
      }

      #image {
        width: 100%;
      }

      #name {
        display: block;
        text-transform: uppercase;
        color: rgb(200, 30, 38);
      }

      #profession {
        text-transform: uppercase;
      }

      .divisor {
        display: block;
        border-width: 0.1px;
        border-color: whitesmoke;
        border-style: solid;
        width: 100%;
        height: 0;
      }

      textarea {
        border-color: lightgray;
      }

      #reviews {
        padding-left: 20px;
        padding-right: 20px;
      }

      #ratearea {
        position: relative;
        width: 20%;
        padding-left: 20px;
      }

      #commentarea {
        position: relative;
        width: 120%;
      }
      /* rate button */

      #review {
        width: calc(100% - 20px);
        position: absolute;
        bottom: 0px;
        right: 0px;
      }
      /* rating menu */

      #ratenum {
        width: 100%!important;
      }

      #error-message {
        color: red;
      }
    </style>

    <iron-ajax id="distance-request" url="https://maps.googleapis.com/maps/api/distancematrix/json" params='{{req_distance}}'
      handle-as="json" on-response="_handleResponseDistance">
    </iron-ajax>

    <!-- <ja-distance-calc result={{result}} location={{location}} user-location={{userLocation}}></ja-distance-calc> -->

    <section id="container">

      <section id="left">

        <div id="imagediv">
          <img id="image" src={{image}} />
        </div>

        <div id="name">
          {{lastname}} {{firstname}}
        </div>

        <div id="container-verification"></div>

        <div id="container-claim"></div>

        <div id="profession">
          {{profession}}
        </div>

        <div id="rating">
          Rating : {{_checkratisprovided(rating)}}
        </div>
        <div id="category">
          Category : {{category}}
        </div>

      </section>

      <section id="right">

        <div id="address">
          ADDRESS <br> {{address}}
        </div>

        <br><br>

        <div id="phone">
          PHONE <br> <a id="phonelink"> {{phone_number}} </a>
        </div>

        <br><br> E-MAIL
        <div id="email">
          <a id="emaillink">{{email}}</a>
        </div>

        <br><br>
        <div id="distance">
          Distance from you: {{distance}}
        </div>

      </section>

      <section class="divisor"></section>

      <section id="price">
        Cost/hour: {{_checkprisprovided(price)}}
      </section>

      <section class="divisor"></section>

      <section id="description">
        Description : {{_checkdescisprovided(description)}}
      </section>
      <section id="reviews" style="width: 100%;">
        <div id="user-rating" style="display:flex;">
          <p id="error-message">{{error}}</p>
          <div id="commentarea" style="width:80%">
            <!-- COMMENT <br/> -->
            <textarea rows="5" style="width:100%" id="comm"> </textarea>
          </div>
          <div id="ratearea">
            RATING
            <select id="ratenum" style="width:90%" on-change="_giverating">
            <option value="-">--Give a review--</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
            <!-- <input id="review" type="submit" value="Rate!" on-click="_givereview" /> -->
            <paper-button id="review" disabled style="height:20px; width: 96%; margin-top: 10px;" on-click="_givereview">Rate!</paper-button>
          </div>
        </div>

        <template is="dom-repeat" items="{{reviews}}" as="result">
          <ja-review-element comment={{result.comment}} rating={{result.rating}} date={{result.date}} user={{result.userName}}></ja-review-element>
          <!-- <br/> -->
        </template>
      </section>

      <!-- <section id="review"> -->

      <!-- </section> -->
    </section>

    <iron-ajax id="ajax" url="/freelancer/{{id}}" method="GET" handle-as="json" content-type="application/json" on-response="_finished"></iron-ajax>
    <iron-ajax id="ajax2" url="/freelancer/{{id}}/review" method="POST" handle-as="json" content-type="application/json" on-response="_done">
    </iron-ajax>

    <iron-ajax id="refresh-user" url="/login/{{user.userId}}" method="GET" handle-as="json" content-type="application/json" on-response="_refreshUser">
    </iron-ajax>

  </template>

  <script>
    // (function () {
    //   'use strict';

    Polymer({
      is: "ja-profile",

      properties: {
        id: {
          type: String,
          observer: '_idchanged'
        },
        firstname: {
          type: String
        },
        lastname: {
          type: String
        },
        address: {
          type: String
        },
        description: {
          type: String
        },
        image: {
          type: String
        },
        price: {
          type: String
        },
        profession: {
          type: String
        },
        phone_number: {
          type: String
        },
        email: {
          type: String
        },
        rating: {
          type: String
        },
        category: {
          type: String
        },
        reviews: {
          type: Array
        },

        distance: {
          type: String,
        },

        user: {
          type: Object,
          reflectToAttribute: true,
        },

        userLocation: {
          type: String,
          value: "",
          notify: true,
          // reflectToAttribute: true,
        },
      },

      ready: function () {
        if (this.id !== "" && this.id !== undefined) {
          const ajaxel = this.$.ajax;
          ajaxel.generateRequest();

        }
      },

      _idchanged: function (id) {
        this.id = id;
        if (this.id !== "" && this.id !== undefined) {
          const ajaxel = this.$.ajax;
          ajaxel.generateRequest();
        }
      },

      _checkdescisprovided: function (el) {
        if (el === undefined || el == "" || el === " " || el === null) {
          return "No description provided"
        }
        return el;
      },

      _checkratisprovided: function (el) {
        if (el === undefined || el == "" || el === " " || el === null) {
          return "No rating provided"
        }
        return el + "/*****";
      },

      _checkprisprovided: function (el) {
        if (el === undefined || el == "" || el === " " || el === null) {
          return "No price provided"
        }
        return el + " CHF";
      },

      _finished: function (e) {
        const res = e.detail.response;
        this.$.emaillink.href = "mailto:" + res.email;
        this.$.phonelink.href = "tel:" + res.phone_number.replace(/\s+/g, '');;
        this.firstname = res.firstName;
        this.lastname = res.lastName;
        this.address = res.address;
        this.description = res.description;
        this.email = res.email;
        this.phone_number = res.phone_number;
        this.price = res.price;
        this.profession = res.profession;
        this.image = res.image;
        this.rating = this._setrating(res.rating);
        this.category = res.category;
        this.reviews = res.reviews;
        this.verification = res.verification;

        this.userLocation = this.userLocation || "Lugano, Switzerland";
        this.req_distance = {
          origins: this.location || this.userLocation,
          destinations: this.address,
          key: 'AIzaSyAolcHbiX1slqHH0Vv3F_YC2fI_0JGFGfQ',
        };
        this.$['distance-request'].generateRequest();

        this.$['refresh-user'].generateRequest();

        // TODO: need to find a way to update user

        this.$['container-verification'].innerHTML = this.verification;

      },

      _giverating: function (el) {
        if (this.$.ratenum.value !== "-") {
          // this.$.review.attributes[1] = "enabled";
          this.$.review.disabled = false;
          this.$.review.setAttribute("raised", "");
          // console.log(this.$.review.attributes);
        }
      },

      _setrating: function (n) {
        var res = ""
        while (n > 0) {
          res += "*";
          n--;
        }
        return res;
      },

      _refreshUser: function (e) {
        this.user = e.detail.response.user;

console.log('######$$$');
        console.log(e.detail.response.user);
        if (this.verification == 'none' && (this.user.userPending == 'none')) {
          this.$['container-claim'].innerHTML = '<a href="/claim/' + this.id +
            ' "><paper-button id="btn-claim" raised>Claim</paper-button></a>';
        } else {
          this.$['container-claim'].innerHTML = '';
        }
      },

      _handleResponseDistance: function (response) {
        const rows = response.detail.response.rows[0];
        if (rows) {
          status = response.detail.response.rows[0].elements[0].status;
          if (status !== 'ZERO_RESULTS' && status !== 'NOT_FOUND') {
            const text = response.detail.response.rows[0].elements[0].distance.text;
            const value = response.detail.response.rows[0].elements[0].distance.value;
            // console.log(text);
            this.set('distance', text);
            // this.set('result.distance_value', value);
          }
        }
      },

      _givereview: function () {
        if (this.$.ratenum.value !== "-") {
          if (this.user && this.user.userType !== "guest") {
            this.error = ""
            const ajaxel = this.$.ajax2;
            const d = new Date();
            const obj = {
              comment: this.$.comm.value,
              rating: this.$.ratenum.value,
              date: d,
              userName: this.user.userName
            };
            ajaxel.body = obj;
            ajaxel.generateRequest();
          } else {
            console.log("not logged in");
            this.error = "Please login before writing a review."
          }
        }
      },

      _done: function (el) {
        console.log("Finished", el);
        const d = new Date();
        const obj = {
          comment: this.$.comm.value,
          rating: this.$.ratenum.value,
          date: d,
          userName: this.user.userName
        };
        this.$.comm.value = " ";
        this.$.ratenum.value = "-";
        this.$.review.removeAttribute("raised");
        this.$.review.disabled = true;
        this.unshift('reviews', obj);
      },


    });

    // })();
  </script>

</dom-module>