<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<!-- <link rel="import" href="../../bower_components/app-location/app-location.html"> -->
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../ja-results-list/ja-results-list.html">
<link rel="import" href="../ja-results-item/ja-results-item.html">
<link rel="import" href="../ja-search-element/ja-search-element.html">
<link rel="import" href="../ja-distance-calc/ja-distance-calc.html">
<link rel="import" href="../ja-freelancer-profile/ja-profile.html">
<link rel="import" href="../ja-claim/ja-claim.html">
<link rel="import" href="../ja-admin/ja-admin.html">
<link rel="import" href="../ja-login/ja-login.html">
<link rel="import" href="../ja-freelancer-signup/ja-freelancer-signup.html">
<link rel="import" href="../ja-emergency-call/ja-emergency-call.html">
<link rel="import" href="../ja-notification-page/ja-notification-page.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="stylesheet" type="text/css" href="../style/style.css">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<dom-module id="jobadvisor-app">
  <template>
    <style>
       :host {
        display: block;
      }

      #username {
        color: white;
        text-align: right;
      }

      #loginBtn, #logoutBtn {
        background-color: white;
      }

      #loginBtn, #logoutBtn, #username {
        /*margin: 10px;*/
        float: right;
        /*margin-bottom: 5px;*/
      }
      #login {
        float: right;
        text-align: right;
      }

      #signup-button{
        float:right;
        background-color: var(--paper-yellow-500);
        color: blue;
      }

      #emergency-button{
        float:right;
        background-color: var(--paper-yellow-500);
        color: blue;
      }

      #notification-button{
        float:right;
        background-color: var(--paper-yellow-500);
        color: blue;
      }

    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:view" data="{{routeData}}" tail="{{subroute}}">
    </app-route>
    <app-route route="{{subroute}}" pattern="/:id" data="{{subrouteData}}">
    </app-route>

    <!-- <div id="login"> -->

    <!-- </div> -->
    <template is="dom-if" if="{{_userIsRegistered(user)}}" restamp="true">
      <a href="/signup"><paper-button id="signup-button">CREATE FREELANCER</paper-button></a>
    </template>

    <template is="dom-if" if="{{_userIsRegistered(user)}}" restamp="true">
      <a href="/emergency"><paper-button id="emergency-button">EMERGENCY CALL</paper-button></a>
    </template>

    <template is="dom-if" if="{{_userIsRegistered(user)}}" restamp="true">
      <a href="/notification/{{user._id}}"><paper-button id="notification-button">NOTIFICATIONS</paper-button></a>
    </template>

    <a href="/login"><paper-button id="loginBtn" raised>Login/signup</paper-button></a>
    <paper-button id="logoutBtn" hidden raised>Logout</paper-button>
    <div id="username">
      [[_formatLoginStatus(user)]]
    </div>
    <div id="title-container">
      <a href="/"><img id="page-title" src="../images/logo.png"></a>
    </div>

    <iron-ajax id="reverse-geo-request" url="https://maps.googleapis.com/maps/api/geocode/json" params='{{req_reversegeo}}' handle-as="json"
      on-response="_handleResponse">
    </iron-ajax>

    <div id="background-results"></div>

    <div id="inner-container">
      <iron-pages selected="[[routeData.view]]" attr-for-selected="title" fallback-selection="search" role="main">
        <div title="search">
          <ja-search-element filters={{filters}} results={{results}} location={{location}} user-location=[[userLocation]] profession={{profession}}></ja-search-element>
          <ja-results-list filters={{filters}} results={{results}} location=[[location]] profession={{profession}} user-location=[[userLocation]]></ja-results-list>
        </div>
        <div title="freelancer">
          <ja-profile id={{subrouteData.id}} user-location={{userLocation}} user={{user}}></ja-profile>
        </div>
        <div title="claim">
          <ja-claim id={{subrouteData.id}}></ja-claim>
        </div>
        <div title="admin">
          <ja-admin id={{subrouteData.id}}></ja-admin>
        </div>
        <div title="login">
          <ja-login user={{user}}></ja-login>
        </div>
        <div title="signup">
          <template is="dom-if" if="{{_userIsRegistered(user)}}" restamp="true">
            <ja-freelancer-signup user={{user}}></ja-freelancer-signup>
          </template>
        </div>
        <div title="emergency">
          <template is="dom-if" if="{{_userIsRegistered(user)}}" restamp="true">
            <ja-emergency-call user={{user}} user-location=[[userLocation]]></ja-emergency-call>
          </template>
        </div>
        <div title="notification">
          <template is="dom-if" if="{{_userIsRegistered(user)}}" restamp="true">
            <ja-notification-page user={{user}}></ja-notification-page>
          </template>
        </div>

      </iron-pages>
    </div>


  </template>
  <script>
    Polymer({
      is: 'jobadvisor-app',

      listeners: {
        'loginBtn.tap': '_onLoginTap',
        'logoutBtn.tap': '_onLogoutTap'
      },

      properties: {
        prop1: {
          type: String,
          value: 'jobadvisor-app',
        },
        results: {
          type: Array,
          value: function () {
            return [];
          },
          observer: '_resultsChanged',
        },
        route: {
          type: Object,
        },
        view: {
          type: String,
          reflectToAttribute: true,
        },
        subroute: {
          type: String,
          reflectToAttribute: true,
        },
        location: {
          type: String,
          value: "Lugano, Switzerland",
          observer: '_locationChanged',
          // reflectToAttribute: true,
          notify: true,
        },
        profession: {
          type: String,
          value: "",
          observer: '_professionChanged',
          // reflectToAttribute: true,
          // notify: true,
        },
        userLocation: {
          type: String,
          value: "",
          // notify: true,
          reflectToAttribute: true,
        },
        filters: {
          type: Object,
          observer: '_filtersChanged',
        },
        user: {
          type: Object,
          observer: "_userChanged"
        }
      },

      observers: [
        '_routePageChanged(routeData.view)',
      ],

      _userIsRegistered: function(user) {
        if (user && user.userType !== "guest") return true;
        else return false;
      },

      _formatLoginStatus: function(user) {
        let result = "";
        if (!user || user.userName == "guest") result = "Not logged-in";
        else result = "Logged in as " + user.userName;
        return result;
      },

      _resultsChanged: function (results) {
        this.results = results;
      },
      _userChanged: function (user) {
        console.log(user);
        if (this.user && this.user.userType != "guest") {
          this.$['logoutBtn'].hidden = false;
          this.$['loginBtn'].hidden = true;
        }
      },
      _filtersChanged: function (filters) {
        // console.log("changing filters", filters)
        this.filters = filters;
      },
      _professionChanged: function (profession) {
        this.profession = profession;
      },
      _locationChanged: function (location) {

        // this.location = location;
      },

      _routePageChanged: function (page) {
        this.view = page;
      },

      _onLoginTap: function(evt) {
      },

      _onLogoutTap: function(evt) {
        console.log("Logging out");
        this.set('user', {
          userName: "guest",
          userType: "guest"
        });
        localStorage.removeItem('user');
        this.$['logoutBtn'].hidden = true;
        this.$['loginBtn'].hidden = false;
        location.href = '/';
      },

      _onLogoutResponse: function(response) {
        // TODO
      },

      _getUserLocation: function () {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (position) {
            const lat = position.coords.latitude.toString();
            const lng = position.coords.longitude.toString();
            this.req_reversegeo = {
              latlng: lat + "," + lng,
              key: 'AIzaSyAolcHbiX1slqHH0Vv3F_YC2fI_0JGFGfQ',
            };
            this.$['reverse-geo-request'].generateRequest();

          }.bind(this));
        }
      },

      ready: function () {
        this._getUserLocation();
        if (localStorage.getItem('user')) {
          this.set('user', JSON.parse(localStorage.getItem('user')));
          this.$['logoutBtn'].hidden = false;
        }
        console.log("USER", this.user);
      },

      _handleResponse: function (response) {
        const resp = response.detail.response;
        if (response) {
          this.userLocation = resp.results[0].formatted_address;
          this.location = resp.results[0].formatted_address;
          console.log("Reverse geo response", resp.results[0].formatted_address);
          window.localStorage['userLocation'] = resp.results[0].formatted_address;
        }

      },

    });
  </script>
</dom-module>
